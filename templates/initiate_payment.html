{% extends 'base.html' %}
{% load static %}

{% block title %}Complete Your Payment - BorrowBuddy{% endblock %}

{% block content %}
<section class="section-padding">
    <div class="container text-center">
        <h2>Final Step: Complete Your Payment</h2>
        <p>You are about to rent <strong>{{ item.name }}</strong> for <strong>â‚¹{{ item.rental_fee }}</strong>.</p>
        <p>Your payment window should open automatically. If it doesn't, please click the button below.</p>

        <button id="rzp-button" class="btn btn-primary">Pay Now</button>
    </div>
</section>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    var options = {
        "key": "{{ razorpay_key_id }}",
        "amount": "{{ razorpay_amount }}",
        "currency": "INR",
        "name": "BorrowBuddy",
        "description": "Rental Fee for {{ item.name }}",
        "order_id": "{{ razorpay_order_id }}",
        "handler": function (response){
            // This function is called after a successful payment
            const csrfToken = '{{ csrf_token }}'; // Django's CSRF token isn't needed here because the view is exempt, but it's good practice for other fetch requests

            fetch("{% url 'payment_success' %}", {
                method: 'POST',
                headers: {
                    // We use URLSearchParams, so the browser sets the Content-Type header automatically
                },
                body: new URLSearchParams({
                    'razorpay_payment_id': response.razorpay_payment_id,
                    'razorpay_order_id': response.razorpay_order_id,
                    'razorpay_signature': response.razorpay_signature
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    // Redirect to the home page after successful payment and request
                    window.location.href = "{% url 'home' %}";
                } else {
                    alert('Payment failed: ' + data.message);
                }
            });
        },
        "prefill": {
            "name": "{{ request.user.get_full_name }}",
            "email": "{{ request.user.email }}",
        },
        "theme": {
            "color": "#20c997"
        }
    };
    var rzp = new Razorpay(options);

    // Function to open the checkout
    function openCheckout() {
        rzp.open();
    }

    // Attach the function to the button's click event
    document.getElementById('rzp-button').onclick = function(e){
        openCheckout();
        e.preventDefault();
    }

    // Automatically open the checkout window when the page loads
    openCheckout();
});
</script>
{% endblock %}